## èƒŒæ™¯

ç›®å‰ç§»åŠ¨è®¾å¤‡çš„å±å¹•ä¸Žæ‘„åƒå¤´ä¼ æ„Ÿå™¨æ¯å¹´éƒ½åœ¨æ›´æ–°æ¢ä»£ï¼Œè¶Šæ¥è¶Šå¤šçš„æ–°æœºåž‹èƒ½å¤Ÿé€šè¿‡æ‘„åƒå¤´æ„Ÿåº”å™¨æ•æ‰åˆ° sRGB èŒƒå›´ä»¥å¤–çš„é¢œè‰²ï¼Œç„¶åŽç”Ÿæˆå¹¿è‰²åŸŸå›¾ç‰‡ã€‚ç„¶è€Œå¦‚æžœåº”ç”¨ä¸å¯¹å¹¿è‰²åŸŸè¿›è¡Œé€‚é…ï¼Œä¼šå‡ºçŽ°å¹¿è‰²åŸŸå›¾ç‰‡æ˜¾ç¤ºå¼‚å¸¸çš„é—®é¢˜ã€‚ç›®å‰æˆ‘ä»¬å¯¹å¸¸ç”¨çš„åº”ç”¨è¿›è¡Œæµ‹è¯•ï¼Œå‘çŽ°éƒ¨åˆ†åº”ç”¨çš„æŸäº›åœºæ™¯éƒ½å‡ºçŽ°äº† P3 å¹¿è‰²åŸŸå›¾ç‰‡é¢œè‰²æš—æ·¡çš„æƒ…å†µã€‚

![](image/2850086000403604560.20201214141419.41283260832995014125089050954177.png)

ä¸Šå›¾æ‰€ç¤ºæ˜¯åº”ç”¨æ²¡æœ‰å¯¹å¹¿è‰²åŸŸè¿›è¡Œé€‚é…ä»Žè€Œäº§ç”Ÿ P3 å¹¿è‰²åŸŸå›¾ç‰‡å¤±çœŸçš„ç¤ºä¾‹ï¼Œå…¶ä¸­æ ‡è®°æœ‰ sRGB çš„å›¾ç‰‡ä¸º sRGB è‰²åŸŸå›¾ç‰‡ï¼Œæœªæ ‡è®°çš„ä¸º P3 å¹¿è‰²åŸŸå›¾ç‰‡ï¼Œå¯ä»¥æ˜Žæ˜¾çœ‹å‡ºï¼Œæ— è®ºæ˜¯å¤§å›¾è¿˜æ˜¯ç¼©ç•¥å›¾ï¼ŒP3 å¹¿è‰²åŸŸå›¾ç‰‡çš„é¢œè‰²æ›´åŠ æš—æ·¡ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯æ‚¨çš„åº”ç”¨èƒ½å¤Ÿæ­£ç¡®ã€é«˜æ•ˆåœ°å‘ˆçŽ°å¹¿è‰²åŸŸæ•ˆæžœï¼Œæœ¬æ–‡æä¾›ä¸€äº›æŠ€æœ¯ä¸Šçš„å»ºè®®ï¼Œå¸®åŠ©æ‚¨ä¸ºåº”ç”¨æ·»åŠ å¹¿è‰²åŸŸæ”¯æŒã€‚

## å»ºè®®

å»ºè®®æ‚¨ä¸è¦æ€»æ˜¯å‡å®šå›¾ç‰‡å¤„äºŽ sRGB è‰²åŸŸï¼Œè€Œæ˜¯æ˜Žç¡®å›¾ç‰‡çš„è‰²åŸŸä¿¡æ¯ã€è§£ç æ¨¡å—è‰²åŸŸé…ç½®ä»¥åŠActivity çš„è‰²åŸŸé…ç½®ï¼Œä¿è¯ Activity çš„è‰²åŸŸæ¨¡å¼ä¸Žå›¾ç‰‡è§£ç åŽçš„è‰²åŸŸèŒƒå›´åŒ¹é…ï¼Œé¿å…å¹¿è‰²åŸŸå›¾ç‰‡æ˜¾ç¤ºå¤±çœŸã€‚


å»ºè®®æ‚¨çš„åº”ç”¨åœ¨è§£ç æ¨¡å—ä¸è¦è®¾ç½®å›ºå®šçš„è‰²åŸŸï¼Œè€Œæ˜¯æ ¹æ®è®¾å¤‡å’Œæ˜¾ç¤ºå±æ˜¯å¦æ”¯æŒå¹¿è‰²åŸŸï¼Œactivityæ˜¯å¦å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ä»¥åŠä¸šåŠ¡åœºæ™¯ï¼ŒåŠ¨æ€çš„è®¾ç½®è‰²åŸŸã€‚é¦–å…ˆæ‚¨éœ€è¦åˆ¤æ–­è®¾å¤‡å’Œæ˜¾ç¤ºå±æ˜¯å¦æ”¯æŒå¹¿è‰²åŸŸï¼ŒActivity æ˜¯å¦å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ã€‚å¦‚æžœè®¾å¤‡ä¸æ”¯æŒæˆ–è€… Activity æœªå¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ï¼Œåˆ™éœ€è¦æŠŠæ¯å¼ å›¾ç‰‡è§£ç ä¸º sRGB è‰²åŸŸã€‚å¦å¤–ï¼Œç”±äºŽå¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼æ—¶ï¼ŒActivity çš„çª—å£å°†æ›´å¤šå†…å­˜å’Œ GPU å¤„ç†èƒ½åŠ›ç”¨äºŽç”»é¢æž„æˆã€‚åœ¨å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ä¹‹å‰ï¼Œæ‚¨åº”ä»”ç»†è€ƒè™‘è¯¥ Activity æ˜¯å¦çœŸçš„èƒ½ä»Žä¸­å—ç›Šã€‚ä¾‹å¦‚ï¼Œä»¥å…¨å±æ¨¡å¼æ˜¾ç¤ºç…§ç‰‡çš„ Activity é€‚åˆä½¿ç”¨å¹¿è‰²åŸŸæ¨¡å¼ï¼Œä½†æ˜¾ç¤ºè¾ƒå°ç¼©ç•¥å›¾çš„ Activity åˆ™ä¸å»ºè®®ã€‚å…·ä½“å†³ç­–æµç¨‹å¦‚å›¾æ‰€ç¤ºã€‚
![](image/2850086000403604560.20201214141821.20885559034510109754520425063042.png)

For Opengl Exampleï¼š

https://android-developers.googleblog.com/2019/05/wide-color-photos-are-coming-to-android.html

å¦‚ä½•æ£€æµ‹è®¾å¤‡å’Œæ˜¾ç¤ºå±ï¼Œå¦‚ä½•å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ä»¥åŠå¦‚ä½•åŠ¨æ€è®¾ç½®å›¾ç‰‡çš„è§£ç è‰²åŸŸå°†åœ¨ä¸‹æ–‡ä»‹ç»ã€‚

## è®¾å¤‡åŠç³»ç»Ÿèƒ½åŠ›æ£€æµ‹

å¦‚æžœæ‚¨çš„åº”ç”¨æƒ³è¦å®žçŽ°å¹¿è‰²åŸŸæ˜¾ç¤ºï¼Œé¦–å…ˆéœ€è¦ç¡®å®šè®¾å¤‡å’Œç³»ç»Ÿä¼šå¦æ”¯æŒã€‚æ‚¨å¯ä»¥é€šè¿‡æŸä¸ªç‰¹å®šæ˜¾ç¤ºå±åŠç³»ç»Ÿæ˜¯å¦æ”¯æŒå¹¿è‰²åŸŸï¼Œå¯ä»¥è°ƒisScreenWideColorGamut()è¿›è¡Œåˆ¤æ–­ï¼Œè¯¥æ–¹æ³•ä»…å½“è®¾å¤‡æ”¯æŒå¹¿è‰²åŸŸï¼Œä¸”æ”¯æŒå¹¿è‰²åŸŸæ¸²æŸ“æ—¶æ‰ä¼šè¿”å›ž trueã€‚

```
Configuration#isScreenWideColorGamut()                                                                                                                                             Added in API level 26


public boolean isScreenWideColorGamut ()


Return whether the screen has a wide color gamut and wide color gamut rendering is supported by this device. When true, it implies the screen is colorspace aware but not necessarily color-managed. The final colors may still be changed by the screen depending on user settings.
```

æ³¨ï¼šä»…åŽä¸º Mate40ç³»åˆ—åŠä»¥åŽçš„è®¾å¤‡æ”¯æŒå¹¿è‰²åŸŸå’Œæ”¯æŒä¸Šè¿° API è¿”å›ž true

# å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼

é€šè¿‡ä¸Šé¢ç« èŠ‚ 3 ä¸­è®¾å¤‡åˆ¤æ–­æ”¯æŒåŽï¼Œåº”ç”¨å¯ä»¥ä½¿ç”¨ colorMode å±žæ€§è¯·æ±‚åœ¨å…¼å®¹è®¾å¤‡ä¸Šä»¥å¹¿è‰²åŸŸæ¨¡å¼ æ˜¾ç¤º Activityã€‚

```
colorMode                                                                                                                                                                                              Added in API level 26


    public static final int colorMode


    Specify the color mode the activity desires. The requested color mode may be ignored depending on the capabilities of the display the activity is displayed on.


     Must be one of the following constant values.


    Constant Value: 16844106 (0x0101054a)
```



## å¯ç”¨å¹¿è‰²åŸŸ

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•å®žçŽ°ï¼Œå…ˆé€šè¿‡è®¾å¤‡åˆ¤æ–­åŽå†é€šè¿‡ä»£ç å®žçŽ°é€‰æ‹©è¦ä¸è¦å¯ç”¨å¹¿è‰²åŸŸæ”¯æŒã€‚å…·ä½“é€šè¿‡ è°ƒç”¨ setColorMode(int) æ–¹æ³•å¹¶ä¼ å…¥ COLOR_MODE_WIDE_COLOR_GAMUTï¼Œåœ¨æ‚¨çš„ Activity ä¸­ä»¥ç¼–ç¨‹ æ–¹å¼è®¾ç½®é¢œè‰²æ¨¡å¼ã€‚


å¦‚æ‚¨å¯ä»¥å†åº”ç”¨ OnCreateçš„æ—¶å€™è¿›å…¥å¦‚ä¸‹è®¾ç½®:
```
getWindow().setColorMode(ActivityInfo.COLOR_MODE_WIDE_COLOR_GAMUT);
```

å¦‚æžœåº”ç”¨æœ‰å¤šä¸ª Activityåº”ç”¨å¯ç”¨å¹¿è‰²åŸŸï¼Œåˆ™éœ€è¦å¯¹æ¯ä¸ª Activityéƒ½è¦è¿›è¡Œä»¥ä¸Šè®¾ç½®ã€‚ å½“ç„¶éœ€è¦å…ˆç»è¿‡ Configuration#isScreenWideColorGamut() åˆ¤æ–­è®¾å¤‡åŠç³»ç»Ÿæ”¯æŒåŽå†å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼ã€‚ å¦‚æžœè®¾å¤‡æ”¯æŒï¼Œå¯ç”¨å¹¿è‰²åŸŸï¼Œéœ€è¦é’ˆå¯¹å½“å‰ Activity åŠ è½½çš„å›¾ç‰‡æ ¹æ®ä¸åŒæŽ§ä»¶å±•ç¤ºå›¾ç‰‡çš„æ–¹å¼é€‰æ‹©ä¸åŒ çš„æ–¹å¼å®žçŽ°è‰²åŸŸè½¬æ¢å³å¯ã€‚

å‚è€ƒé“¾æŽ¥ï¼š

  [setColorMode(int)](https://developer.android.google.cn/reference/android/view/Window.html#setColorMode(int))

  [COLOR_MODE_WIDE_COLOR_GAMUT](https://developer.android.google.cn/reference/android/content/pm/ActivityInfo.html#COLOR_MODE_WIDE_C%20OLOR_GAMUT)

åˆ¤æ–­åº”ç”¨å¯ç”¨å¹¿è‰²åŸŸæ¨¡å¼æ˜¯å¦æˆåŠŸ

åº”ç”¨æ˜¯å¦å¯ç”¨å¹¿è‰²åŸŸæˆåŠŸï¼Œä¸€ç§æ–¹æ³•æ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥ getColorMode() æ–¹æ³•æ˜¯å¦è¿”å›ž COLOR_MODE_WIDE_COLOR_GAMUT æ¥éªŒè¯æ‚¨çš„åº”ç”¨æ˜¯å¦æ­£ç¡®è¯·æ±‚äº†å¹¿è‰²åŸŸæ¨¡å¼ã€‚ å¦‚é€šè¿‡åœ¨åº”ç”¨ä¸­ä½¿ç”¨ getWindow().getColorMode();



å¦å¤–ä¸€ç§æ–¹æ³•ä¹Ÿå¯ä»¥åˆ¤æ–­ï¼šåº”ç”¨å¯ç”¨å¹¿è‰²åŸŸåŽï¼Œæ‚¨å¯ä»¥åœ¨åº”ç”¨å›¾ç‰‡æ˜¾ç¤ºç•Œé¢æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼šadb shell dumpsys SurfaceFlinger æŸ¥çœ‹åº”ç”¨å¯¹åº”å›¾å±‚å±žæ€§ dataspace ä¸­æœ‰ 0088a0000 è¿™ä¸€æ ‡è¯†å³ P3 å¹¿è‰²åŸŸæ ‡è¯† å³ç”Ÿæ•ˆ
![](image/2850086000403604560.20201214144049.67486436714483194038142040573550.png)

## åŽŸç†ç®€ä»‹

å½“åº”ç”¨å¯ç”¨å¹¿è‰²åŸŸæ ‡è¯†åŽï¼Œæ ‡è¯†ç»è¿‡ VIEW => HWUI =>  GUI => SURFACEFLINGER => HWCä¼  é€’ åœ¨åº•å±‚ HWC æ¨¡å—ä¼šè¿›è¡Œè¯†åˆ«å¹¿è‰²åŸŸ dataå¹¶è¿›è¡Œæ˜¾ç¤ºå±‚ä¸åŒçš„è‰²åŸŸè½¬æ¢å¤„ç†ï¼ˆè¿™é‡Œä¸åŒäºŽå›¾ç‰‡è§£ç  çš„è‰²åŸŸè½¬æ¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¿è¯è§£ç çš„è‰²åŸŸä¸Žåº•å±‚æ˜¾ç¤ºå±‚è‰²åŸŸç»Ÿä¸€å³å¯ï¼‰å¹¶è¿›ä¸€æ­¥åº”ç”¨æ˜¾ç¤ºæ•ˆæžœè¾¾åˆ°å± å¹•ã€‚ç®€åŒ–çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š
![](image/2850086000403604560.20201214144146.86904764866631637420224389332210.png)

## P3 å¹¿è‰²åŸŸåœºæ™¯å»ºè®®ï¼š

* æ³¨æ„ 1ï¼šå»ºè®®åœ¨æ”¯æŒ P3å¹¿è‰²åŸŸæ‹ç…§å’Œå¹¿è‰²åŸŸè‰²å½©ç®¡ç†çš„è®¾å¤‡ä¸Šï¼Œç”¨æˆ·ç…§ç‰‡çš„æ˜¾ç¤ºæµè§ˆåœºæ™¯é‡‡ç”¨ P3å¹¿è‰² åŸŸçš„è‰²å½©æ˜¾ç¤ºæ•ˆæžœã€‚æ¯”å¦‚å¤§å›¾ã€å…¨å±æ˜¾ç¤ºç…§ç‰‡åœºæ™¯ï¼Œä¸å»ºè®®åœ¨æ˜¾ç¤ºå°ç¼©ç•¥å›¾ç­‰æˆ–è€…ä¸æ¶‰åŠå›¾ç‰‡å±•ç¤ºåœºæ™¯ å¯ç”¨å¹¿è‰²åŸŸï¼›

* æ³¨æ„ 2ï¼šå¯ç”¨å¹¿è‰²åº”ç”¨ Activityçª—å£æ¸²æŸ“æ—¶ä¼šå¢žåŠ ç›¸åº”çš„ç³»ç»Ÿå¼€é”€ï¼Œå¦‚å†…å­˜ã€gpuç®—åŠ›ï¼Œæ‰€ä»¥è¯·åº”ç”¨ä¸š åŠ¡æœ¬èº«ä½œå¥½è¯„ä¼°ï¼›

* æ³¨æ„ 3ï¼šå¹¿è‰²åŸŸé…ç½®åªæ˜¯æ˜¾ç¤ºé’ˆå¯¹å›¾ç‰‡åœ¨å¹¿è‰²åŸŸåœºæ™¯æˆ–è€…è¯´å›¾ç‰‡å«æœ‰ ICC profiles çš„å›¾ç‰‡ï¼ˆå¦‚ JPEGï¼Œ PNG,WebPï¼‰ï¼Œå¦‚æžœå›¾ç‰‡ä¸æ˜¯å¹¿è‰²åŸŸçš„è¿˜æ˜¯éœ€è¦è½¬æ¢ä¸ºå¹¿è‰²åŸŸå¤„ç†ã€‚æ¯”å¦‚é’ˆå¯¹åº”ç”¨å±•ç¤ºå›¾ç‰‡çš„ä¸åŒå®žçŽ° æ–¹å¼è€ƒè™‘è§£ç æ—¶éœ€è¦å°† sRGB å›¾ç‰‡è½¬æ¢åˆ° P3å¹¿è‰²åŸŸæˆ–è€…é€šè¿‡é€šè¿‡ gpu shader å®žçŽ°è‰²åŸŸçš„è½¬æ¢ï¼Œé’ˆå¯¹ Googleæ ‡å‡†æŽ¥å£è§£ç ç›®æ ‡è‰²åŸŸè½¬æ¢å‚è€ƒæŽ¥å£ 4.4 ç³»ç»ŸæŽ¥å£å®žçŽ°ï¼Œgpu  shader åŽŸç†åŒä¸‹ 5.3.2 å®žçŽ°è‰²åŸŸè½¬ æ¢ã€‚

## è®¾ç½®ç›®æ ‡è§£ç é¢œè‰²ç©ºé—´

å¯ç”¨å¹¿è‰²åŸŸåŽï¼Œéœ€è¦è®¾ç½®å›¾ç‰‡è§£ç æ˜¾ç¤ºæŒ‡å®šé¢œè‰²ç©ºé—´å¹¿è‰²åŸŸï¼Œæ‰èƒ½å®žçŽ°å¹¿è‰²åŸŸæ•ˆæžœã€‚é’ˆå¯¹èµ°ç³»ç»ŸæŽ¥å£çš„åº”ç”¨ï¼ˆç›®å‰åªé’ˆå¯¹ç³»ç»Ÿæ ‡å‡†æŽ¥å£ï¼‰ï¼ŒAndroid å¯¹ P3çš„æ ¼å¼è½¬æ¢æœ‰ä»¥ä¸‹ 3 ç§ APIå®žçŽ°ã€‚

* 1ï¼‰BitmapFactory

* 2ï¼‰BitmapRegionDecoder

* 3ï¼‰ImageDecoder

è¯¦ç»†çš„å®žçŽ°éƒ¨åˆ†å¯ä»¥å‚è€ƒä¸‹é¢å‡ ä¸ªå°èŠ‚ï¼š
### BitmapFactory

åœ¨ Android API ä¸­é€šè¿‡ android.graphics.BitmapFactory å¯ä»¥å®žçŽ°è§£ç å›¾ç‰‡æ–‡ä»¶ï¼ˆå…¨è§£ç ï¼‰ï¼Œè¿™å…¶ä¸­åŒ…æ‹¬äº†é€šè¿‡æ–‡ä»¶ã€æµã€æ•°å­—åˆ›å»ºè§£ç å™¨ã€‚é€šè¿‡åœ¨ BitmapFactory.Option ä¸­è®¾ç½® inPreferredColorSpace å‚æ•°ï¼Œå…è®¸æ‚¨ä¸ºå·²è§£ç çš„ Bitmap æ–‡ä»¶æŒ‡å®šç›®æ ‡è‰²å½©ç©ºé—´ã€‚å‡è®¾æ‚¨çŽ°åœ¨æƒ³è¦è§£ç ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ç”¨

ä¸‹é¢çš„ä»£ç è¿›è¡Œè‰²å½©ç®¡ç†ã€‚çŽ°åœ¨å¤§éƒ¨åˆ†åº”ç”¨è°ƒç”¨çš„æ˜¯ BitmapFactoryè§£ç ã€‚APP å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œè®¾ç½®ã€‚
```
final BitmapFactory.Options options = new BitmapFactory.Options();


// Decode this file to sRGB color space.


options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.SRGB);


// Decode this file to P3 color space


// options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.DISPLAY_P3);


Bitmap bitmap = BitmapFactory.decodeFile(FILE_PATH, options);
```

ä¸Šè¿°ä»£ç æŠŠç›®æ ‡è‰²åŸŸç©ºé—´è®¾ç½®æˆ SRGB æˆ–è€…è®¾ç½® DISPLAY_P3ï¼Œ ä¿å­˜åœ¨ options å‚æ•°é‡Œã€‚

ç„¶åŽè°ƒç”¨è§£ç  API decodeFile è¿›è¡Œè§£ç ï¼ˆå…¶ä»– decodeXXX æŽ¥å£ç±»ä¼¼ï¼‰ã€‚BitmapFactoryé‡Œæœ‰ 5 ä¸ªAPIè§£ç æŽ¥å£ä¾›åº”ç”¨ä½¿ç”¨ã€‚å¦‚ä¸‹ï¼š
```
public static Bitmap decodeFile(String pathName, Options opts)
public static Bitmap decodeFileDescriptor(FileDescriptor fd, Rect outPadding, Options opts)
public static Bitmap decodeByteArray(byte[] data, int offset, int length, Options opts) public
public static Bitmap decodeResource(Resources res, int id, Options opts)
```
Android é‡Œä¸Žæœ¬æ¬¡è®¨è®ºçš„å›¾ç‰‡è‰²åŸŸè®¾ç½®ç›¸å…³çš„å›¾ç‰‡æ ¼å¼å¦‚ä¸‹ï¼š

| SRGB  |ADOBE_RGB | DISPLAY_P3 |
|--|--|--|


ADOBE_RGB å¾ˆå°‘æ¶‰åŠï¼Œå› æ­¤æ‚¨ä¸»è¦è€ƒè™‘ SRGB å’Œ DISPLAY_P3 ä¸¤ç§å›¾ç‰‡æ ¼å¼ã€‚

### BitmapRegionDecoder

åœ¨ Android APIä¸­é€šè¿‡ android.graphics.BitmapRegionDecoder å®žçŽ°è§£ç å›¾ç‰‡çš„æŸä¸€å—çŸ©å½¢åŒºåŸŸï¼ˆåŒº åŸŸè§£ç ï¼‰ã€‚é€šè¿‡åœ¨ BitmapFactory.Option è®¾ç½® inPreferredColorSpace å‚æ•°ï¼Œå…è®¸æ‚¨ä¸ºå·²è§£ç çš„ Bitmap æ–‡ ä»¶æŒ‡å®šç›®æ ‡è‰²å½©ç©ºé—´ã€‚å‡è®¾æ‚¨çŽ°åœ¨æƒ³è¦è§£ç ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œè‰²å½©ç®¡ç†ã€‚å¦‚ APP å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œè®¾ç½®ç›®æ ‡ ColorSpaceã€‚


```
final BitmapFactory.Options options = new BitmapFactory.Options();
LOCAL_STATIC_JAVA_LIBRARIES

// Set sRGB colorspace when decoding by setting Options.inPreferredColorSpace


options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.SRGB);


// Decode this file to P3 color space

LOCAL_STATIC_JAVA_LIBRARIES
// options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.DISPLAY_P3);


Rect rect = new Rect(100, 100); // create a rect region


// Decodes a rectangle region in the image specified by rect
LOCAL_STATIC_JAVA_LIBRARIES

BitmapRegionDecoder regionDecoder = BitmapRegionDecoder.newInstance(is, false);

```

ä¸Šè¿°ä»£ç æŠŠç›®æ ‡è‰²åŸŸç©ºé—´è®¾ç½®æˆ SRGB æˆ–è€… P3ï¼Œ ä¿å­˜åœ¨ options å‚æ•°é‡Œã€‚ç„¶åŽè°ƒç”¨è§£ç  API  decodeRegionè¿›è¡Œè§£ç ã€‚

### ImageDecoderLOCAL_STATIC_JAVA_LIBRARIES

ä»Ž Android P (API ç­‰çº§ 28) å¼€å§‹ï¼ŒAndroid å¼•å…¥äº†çŽ°ä»£åŒ–å›¾ç‰‡è§£ç å·¥å…· ImageDecoderã€‚å¦‚æžœæ‚¨å·²å°†

APK å‡çº§è‡³ API ç­‰çº§ 28 æˆ–æ›´é«˜ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ ImageDecoderï¼Œè€Œéž BitmapFactory æˆ– BitmapFactory.Option APIã€‚ä½†æ˜¯å¤§éƒ¨åˆ†åº”ç”¨è¿˜æ˜¯ä½¿ç”¨ BitmapFactoryã€‚

é’ˆå¯¹ ImageDecoder å¯ä»¥é€šè¿‡ ImageDecoder.setTargetColorSpace å®žçŽ°ç›®æ ‡è‰²å½©ç©ºé—´è½¬æ¢ï¼š

```
ImageDecoder.Source source = ImageDecoder.createSourcLOCAL_STATIC_JAVA_LIBRARIESe(FILE_PATH);

try {

    bitmap = ImageDecoder.decodeBitmap(source,
            new ImageDecoder.OnHeaderDecodedListener() {
                @Override
                public void onHeaderDecoded(ImageDecoder decoder,
                        ImageDecoder.ImageInfo info,
                        ImageDecoder.Source source) {
                     decoder.setTargetColorSpace(ColorSpace.get(Named.SRGB));
                    // Decode this file to P3 color space

                    // decoder.setTargetColorSpace(ColorSpace.Named.DISPLAY_P3);
                }
            });
} catch (IOException e) {

  // handle exception.
}
```
å¦‚ä¸Šç¤ºä¾‹ä»£ç ä½¿ç”¨ ImageDecoder#decodeBitmap API å°†å›¾ç‰‡è½¬æ¢ä¸º sRGB æˆ–è€… P3ä½å›¾ã€‚åº”ç”¨åœ¨è°ƒç”¨è§£ç çš„ APIæŽ¥å£å‰ï¼ŒæŠŠè‰²åŸŸè®¾ç½®æˆ SRGB æˆ–è€… P3ã€‚


## å¹¿è‰²åŸŸå…¼å®¹æ€§æ–¹æ¡ˆ

åº”ç”¨ä¸å¯ä»¥å‡è®¾è¾“å…¥çš„å¤–éƒ¨å›¾ç‰‡ä½¿ç”¨ sRGB è‰²å½©ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåº”ç”¨å¿…é¡»è‡ªè¡Œæ£€æŸ¥å·²è§£ç å›¾ç‰‡çš„ è‰²å½©ç©ºé—´ï¼Œå¹¶è¿›è¡Œå¿…è¦è½¬æ¢ã€‚å¦‚æžœæ²¡æœ‰åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´è‰²å½©å¤±çœŸï¼Œæˆ–è€…è‰²å½©é…ç½®æ–‡ä»¶åœ¨æŸä¸ªçŽ¯ èŠ‚ä¸è¢«æŽ¥å—ã€‚æ¯”å¦‚å·²çŸ¥çš„é—®é¢˜åœºæ™¯æœ‰ï¼š
```
    æ€»æ˜¯å‡å®šå›¾ç‰‡å¤„äºŽ sRGB è‰²å½©ç©ºé—´

    æ²¡æœ‰è¿›è¡Œå¿…è¦è½¬æ¢ï¼Œä¾¿å°†å›¾ç‰‡ä¸Šä¼ ä¸ºçº¹ç†ï¼Œæ¯”å¦‚ä¸€äº›è§†é¢‘æ•ˆæžœåœºæ™¯ï¼Œç›´æŽ¥æ‹¿è§£ç çš„ pixels ä¸Šä¼  gpuï¼›

    åœ¨åŽ‹ç¼©æ—¶å¿½ç•¥ ICC é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚æœ‰äº›åœºæ™¯ä¼šå¯¹å›¾ç‰‡ä¸Šä¼ æˆ–è€…åŽ‹ç¼©å¤„ç†ï¼Œä¸¢å¤±äº† iccï¼›
```
å› æ­¤åº”ç”¨æœ¬èº«ä¹Ÿéœ€è¦æœ‰å…¼å®¹æ€§æ–¹æ¡ˆèƒ½å¤Ÿä½¿å¾— P3 å¹¿è‰²åŸŸå›¾ç‰‡æ˜¾ç¤ºæ­£ç¡®ã€‚èµ°ç³»ç»Ÿæ ‡å‡†æŽ¥å£çš„ä¼šæœ‰ç³»ç»Ÿ å…¼å®¹æ€§æ–¹æ¡ˆï¼Œè¿˜æœ‰ä¸€äº›æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿæ ‡å‡†æŽ¥å£è€Œé‡‡ç”¨å…¶ä»–å¼€æºåº“æˆ–è€…ç¬¬ä¸‰æ–¹è§£ç åº“åˆ™éœ€è¦åº”ç”¨å•ç‹¬é€‚ é…ã€‚

### Fresco é€‚é…

ä»Žæˆ‘ä»¬ç›®å‰çš„æµ‹è¯•ç»“æžœæ¥çœ‹ï¼Œå½“åº”ç”¨ä½¿ç”¨ Fresco ä¸‰æ–¹å¼€æºæ¡†æž¶å¹¶ä¸”è¿›è¡Œå°ºå¯¸ç¼©æ”¾æˆ–è€…æ—‹è½¬çš„æ“ä½œä¹‹åŽï¼ŒP3å›¾ç‰‡æ˜¾ç¤ºä¼šæœ‰å¤±çœŸçš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬å»ºè®®å¯ä»¥ä½¿ç”¨ javaæŽ¥å£è¿›è¡Œè½¬æ¢è€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„ native C/C++æŽ¥å£ã€‚å…·ä½“ä»£ç å®žçŽ°å¦‚ä¸‹ï¼š
```
ImagePipelineConfig.Builder builder = ImagePipelineConfig.newBuilder(this);

builder.setImageTranscoderFactory(new SimpleImageTranscoderFactory((int) BitmapUtil.MAX_BITMAP_SIZE));

ImagePipelineConfig config = builder.build();

Fresco.initialize(this, config);
```

### Glide é€‚é…

Glideçš„åœ¨ P ç‰ˆæœ¬ä»¥ä¸Šé»˜è®¤ SRGBï¼Œä¸ºäº†å‡å°‘ä¸å¿…è¦è‰²åŸŸè½¬æ¢å¸¦æ¥çš„ cpuå¼€é”€ï¼Œæˆ‘ä»¬å»ºè®®é’ˆå¯¹æ–°äº§å“ä¸Š é…ç½®é»˜è®¤ä¸º DISPLAY_P3
![](image/2850086000403604560.20201214150013.52136372805408050832283239021927.png)

### å…¶ä»–éž Android ç³»ç»ŸæŽ¥å£é€‚é…æŒ‡å¯¼

å½“åº”ç”¨ä¸æ”¯æŒå¹¿è‰²åŸŸæ—¶ï¼Œåˆ™éœ€è¦å…¼å®¹å¹¿è‰²åŸŸå›¾ç‰‡ï¼Œå°±éœ€è¦ä¿è¯å¹¿è‰²åŸŸ P3çš„å›¾ç‰‡è§£ç è½¬æ¢è‡³ sRGBï¼Œå…·ä½“çš„è½¬æ¢å¦‚ä¸‹é¢ä»‹ç»ï¼ˆæ³¨ï¼šä¸‹é¢æ–¹æ³•åªæ˜¯æœ€ç®€å•çš„è½¬æ¢æ–¹å¼ï¼Œæ²¡æœ‰è€ƒè™‘æ›´å¤šç»†èŠ‚ï¼‰

`åŽŸç†`

ä¸åŒè‰²åŸŸçš„å›¾åƒï¼Œå³ä½¿è®¾å¤‡ RGB ç›¸åŒï¼Œå…¶ç¼–ç æ‰€è¡¨ç¤ºçš„è‰²å½©ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥å½“å½©è‰²å›¾åƒåœ¨ä¸åŒ çš„è®¾å¤‡ä¹‹é—´ä¼ è¾“å’Œæ˜¾ç¤ºæ—¶ï¼Œå¸¸ä¼šå‡ºçŽ°é¢œè‰²å¤±çœŸçŽ°è±¡ã€‚ç›®å‰å…¬è®¤çš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡è®¾è®¡åˆç†çš„è‰²åŸŸæ˜ å°„ç®— æ³•æ¥æ”¹å–„é¢œè‰²å¤±çœŸé—®é¢˜.

è‰²åŸŸæ˜ å°„æœ€ç®€å•æ–¹å¼é€šè¿‡ 3x3çŸ©é˜µæ–¹å¼å®žçŽ°ï¼Œæœ‰æº¢å‡ºæˆªæ–­å¤„ç†å³å¯ã€‚å…·ä½“åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

* a) å…ˆåš degamma åœ¨åŽŸè‰²åŸŸ RGB ç©ºé—´ç”±éžçº¿æ€§è½¬ä¸ºçº¿æ€§ï¼Œ

* b) ç„¶åŽåœ¨çº¿æ€§åŸŸç©ºé—´é€šè¿‡ 3x3 çŸ©é˜µè½¬ä¸ºç›®æ ‡è‰²åŸŸ RGB ç©ºé—´ï¼Œ

* c) æœ€åŽå†ç›®æ ‡è‰²åŸŸé€šè¿‡ gamma ç”±çº¿æ€§è½¬å›žéžçº¿æ€§ã€‚

`è‰²åŸŸè½¬æ¢ä¼ªä»£ç å®žçŽ° `

* 1) Degamma çº¿æ€§åŒ–
```
        % è¾“å…¥ rgb 3*1 å‘é‡ï¼Œgamma å€¼

            function out = gammik(rgb, gamma)

            sR=rgb(:,1)./1;

            sG=rgb(:,2)./1;

            sB=rgb(:,3)./1;


            g = gamma;

            %apply gamma function to convert to sRGB

            sr(sR >= 0) = sR(sR >= 0).^g;

            sr(sR <  0) = -((-sR(sR < 0)).^g);

            sg(sG >= 0) = sG(sG >= 0).^g;

            sg(sG <  0) = -((-sG(sG < 0)).^g);

            sb(sB >= 0) = sB(sB >= 0).^g;

            sb(sB <  0) = -((-sB(sB < 0)).^g);

            out=[sr',sg',sb'];

      end
```
 æ³¨ï¼šgamma = 2.2 ä¸ºéžçº¿æ€§åˆ°çº¿æ€§ï¼Œ gamma = 1/2.2 çº¿æ€§è½¬éžçº¿æ€§


* 2)  Gamut Mapping

     a) è®¡ç®—çŸ©é˜µ M

 ð‘€ = ð‘€2 âˆ’1 âˆ— ð‘€1

 å…¶ä¸­ð‘€1ä¸ºåŽŸè‰²åŸŸ RGB åˆ° XYZ çš„è½¬æ¢çŸ©é˜µï¼ŒM2 ä¸ºç›®æ ‡è‰²åŸŸ RGB åˆ° XYZ çš„è½¬æ¢çŸ©é˜µï¼Œð‘€2 âˆ’1ä¸º XYZ åˆ°ç›®æ ‡è‰²åŸŸ RGB çš„è½¬æ¢çŸ©é˜µå³ M2çš„é€†çŸ©é˜µï¼Œå…·ä½“çŸ©é˜µæ•°å€¼å‚è€ƒï¼š http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html

 è¡¥å……è¯´æ˜Ž sRGB å’Œ Display-P3 çŸ©é˜µ

| GB Working Space |Reference White|RGB to XYZ [M]|	XYZ to RGB [M]-1|
|--|--|--|--|
|sRGB|D50|0.4360747  0.3850649  0.1430804  0.2225045  0.7168786  0.0606169  0.0139322  0.0971045  0.7141733  | 3.1338561 -1.6168667 -0.4906146 -0.9787684  1.9161415  0.0334540  0.0719453 -0.2289914  1.4052427 |
|Display-P3 |D50| 0.515097  0.291970  0.157145 0.241179  0.692244  0.066576  -0.001049  0.041883  0.784354  |2.404071 -0.989915 -0.397631 -0.842217 1.798831 0.016053 0.048188 -0.097378 1.273546 |

* b) M*RGB
```
    % è¾“å…¥ RGB 3x1 å‘é‡ï¼ŒM 3x3 è½¬æ¢çŸ©é˜µï¼Œè¾“å‡º RGB 3x1 å‘é‡

    function out = ColorSpaceTransform(RGB,M)

         ourt = M * RGB;

   end
```

æ¯”å¦‚ P3 â€“> sRGB, åˆ™ä¸º M = [MsRGBToxyz]-1*Mp3toxyz = MxyztosRGB * Mp3toxyz

* 3) Gamma éžçº¿æ€§åŒ–

```
function out = gammik2(sRGB, gamma)

  sR=sRGB(:,1);

  sG=sRGB(:,2);

  sB=sRGB(:,3);

  g=1/gamma;

  sR(sR >= 0) = sR(sR >= 0).^g;

  sR(sR <  0) = -((-sR(sR < 0)).^g);


  sG(sG >= 0) = sG(sG >= 0).^g;

  sG(sG <  0) = -((-sG(sG < 0)).^g);

  sB(sB >= 0) = sB(sB >= 0).^g;

  sB(sB <  0) = -((-sB(sB < 0)).^g);


  R=sR*1;

  G=sG*1;

  B=sB*1;


  out=[R,G,B];

  end
```
æŒ‰ç…§å¦‚ä¸Šæ–¹å¼å¯ä»¥ç®€å•å®žçŽ°é’ˆå¯¹ P3 åˆ° sRGB çš„è‰²åŸŸè½¬æ¢ã€‚

##Google Android è½¬æ¢å‚è€ƒ

æˆ‘ä»¬åœ¨ Google Android ç³»ç»Ÿä¸­ä¹Ÿå‘çŽ°ç±»ä¼¼å¯ä»¥å®žçŽ°è½¬æ¢ï¼Œå¯ä»¥å‚è€ƒï¼š

https://cs.android.com/android/platform/superproject/+/master:frameworks/native/libs/ui/ColorSpace.cpp;l=250%20?q=colorspace

é’ˆå¯¹ iccçš„å¤„ç†å¯ä»¥å‚è€ƒï¼š

https://cs.android.com/android/platform/superproject/+/master:external/skia/src/codec/SkJpegCodec.cpp;bpv=1;%20bpt=1;l=134?q=skjpegcodec

ä¸‰æ–¹åº“å¯ä»¥å®žçŽ°è½¬æ¢ï¼Œå…·ä½“ä¸‰æ–¹åº“é“¾æŽ¥å¦‚ä¸‹ ï¼š

https://github.com/google/skia/blob/master/third_party/skcms/skcms.cc

å…¶ä¸­çš„ skcms_Transformå‡½æ•°å¯ä»¥å‚è€ƒã€‚
